<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title></title>
        <link>localhost/blog</link>
        <description>Some thoughts</description>
        <lastBuildDate>Tue, 03 Jun 2025 06:13:34 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Address lookup - Part 2 - API]]></title>
            <link>localhost/blog/blog/posts/2025/address_lookup-part3-api.html</link>
            <guid>localhost/blog/blog/posts/2025/address_lookup-part3-api.html</guid>
            <pubDate>Thu, 01 May 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[<p><em>Executive summary</em>: In Belgium, a collaborative effort between regional and federal authorities has led to the creation of a unified service that aggregates all Belgian addresses into a comprehensive dataset. This article will guide you through the process of using this valuable resource to efficiently look up addresses based on postal codes, streetnames and house numbers.</p>
]]></description>
            <content:encoded><![CDATA[<p><em>Executive summary</em>: In Belgium, a collaborative effort between regional and federal authorities has led to the creation of a unified service that aggregates all Belgian addresses into a comprehensive dataset. This article will guide you through the process of using this valuable resource to efficiently look up addresses based on postal codes, streetnames and house numbers.</p>
<hr>
<h2 id="api-houte-si-true" tabindex="-1">API Houte-Si-<code>True</code> <a class="header-anchor" href="#api-houte-si-true" aria-label="Permalink to &quot;API Houte-Si-`True`&quot;">&ZeroWidthSpace;</a></h2>
<ImageCenter src="https://i.imgur.com/GJNQQJA.png" alt="Houte Si True" width="300" /><h2 id="api-development-with-fastapi" tabindex="-1">API Development with FastAPI <a class="header-anchor" href="#api-development-with-fastapi" aria-label="Permalink to &quot;API Development with FastAPI&quot;">&ZeroWidthSpace;</a></h2>
<p>The HouteSiTrue API was developed using FastAPI, a modern, fast web framework for building APIs with Python. The API serves as a bridge between our legacy GEOG system (or any other address system) and the BestAddress reference dataset, providing efficient address lookup and matching capabilities.</p>
<h3 id="core-components" tabindex="-1">Core Components <a class="header-anchor" href="#core-components" aria-label="Permalink to &quot;Core Components&quot;">&ZeroWidthSpace;</a></h3>
<ol>
<li><strong>Router Structure</strong>
The API is organized using FastAPI's router system, with the main address-related endpoints grouped under the <code>/addresses</code> prefix:</li>
</ol>
<div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #BABED8">router </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">APIRouter</span><span style="color: #89DDFF">(</span><span style="color: #BABED8; font-style: italic">prefix</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">/addresses</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #BABED8; font-style: italic">tags</span><span style="color: #89DDFF">=[</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">addresses</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">])</span></span></code></pre>
</div><ol start="2">
<li><strong>Key Endpoints</strong></li>
</ol>
<ul>
<li><strong>Single Address Lookup</strong>: Retrieve address details by unique identifier</li>
<li><strong>Street Listings</strong>: Get streets by postcode or municipality</li>
<li><strong>Address Matching</strong>: Find the best match for given address components</li>
<li><strong>Batch Processing</strong>: Handle multiple address lookups in a single request</li>
<li><strong>Distance Calculations</strong>: Compute distances between geographical locations</li>
<li><strong>Similar Street Names</strong>: Find similar street names within a specified area</li>
</ul>
<h3 id="address-matching-logic" tabindex="-1">Address Matching Logic <a class="header-anchor" href="#address-matching-logic" aria-label="Permalink to &quot;Address Matching Logic&quot;">&ZeroWidthSpace;</a></h3>
<p>The core functionality revolves around the address matching system, which uses both strict and fuzzy matching. The implementation combines FastAPI endpoints with sophisticated SQL queries for accurate address matching:</p>
<div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #89DDFF">@</span><span style="color: #82AAFF">router</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">post</span><span style="color: #89DDFF">(</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">/bestmatch</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #BABED8; font-style: italic">operation_id</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">find_bestmatch_for_address</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">)</span></span>
<span class="line"><span style="color: #C792EA">async</span><span style="color: #BABED8"> </span><span style="color: #C792EA">def</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">find_bestmatch_for_address</span><span style="color: #89DDFF">(</span><span style="color: #BABED8; font-style: italic">body</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> AddressRequest</span><span style="color: #89DDFF">,</span><span style="color: #BABED8"> </span><span style="color: #BABED8; font-style: italic">request</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> Request</span><span style="color: #89DDFF">):</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #89DDFF; font-style: italic">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color: #676E95; font-style: italic">    Retrieve the best match for an address.</span></span>
<span class="line"><span style="color: #676E95; font-style: italic">    - postcode: strict matching</span></span>
<span class="line"><span style="color: #676E95; font-style: italic">    - street_name: fuzzy matching</span></span>
<span class="line"><span style="color: #676E95; font-style: italic">    - house_number: strict matching</span></span>
<span class="line"><span style="color: #676E95; font-style: italic">    - box_number: strict matching</span></span>
<span class="line"><span style="color: #676E95; font-style: italic">    </span><span style="color: #89DDFF; font-style: italic">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color: #BABED8">    results </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #BABED8"> find_address</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">bestmatch</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">body</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> request</span><span style="color: #89DDFF">)</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #89DDFF; font-style: italic">return</span><span style="color: #BABED8"> results</span></span></code></pre>
</div><p>Under the hood, the bestmatch function utilizes a SQL query that implements fuzzy matching using Levenshtein distance and Jaro similarity scores:</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight has-focused-lines" ><code><span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #82AAFF">count</span><span style="color: #BABED8">(</span><span style="color: #89DDFF">*</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> addresses_count</span></span>
<span class="line"><span style="color: #BABED8">, street_id</span></span>
<span class="line"><span style="color: #BABED8">, municipality_id</span></span>
<span class="line"><span style="color: #BABED8">, </span><span style="color: #82AAFF">lower</span><span style="color: #BABED8">(strip_accents(streetname_fr)) </span><span style="color: #F78C6C">as</span><span style="color: #BABED8"> streetname_fr_striped</span></span>
<span class="line"><span style="color: #BABED8">, </span><span style="color: #82AAFF">lower</span><span style="color: #BABED8">(strip_accents(streetname_nl)) </span><span style="color: #F78C6C">as</span><span style="color: #BABED8"> streetname_nl_striped</span></span>
<span class="line"><span style="color: #BABED8">, </span><span style="color: #82AAFF">lower</span><span style="color: #BABED8">(strip_accents(streetname_de)) </span><span style="color: #F78C6C">as</span><span style="color: #BABED8"> streetname_de_striped</span></span>
<span class="line"><span style="color: #BABED8">, default_streetname</span></span>
<span class="line"><span style="color: #BABED8">, </span><span style="color: #82AAFF">greatest</span><span style="color: #BABED8">(</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">-</span><span style="color: #BABED8"> (</span></span>
<span class="line has-focus"><span style="color: #BABED8">    levenshtein(streetname_fr_striped, </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">{street_name}</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">greatest</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">length</span><span style="color: #BABED8">(streetname_fr_striped), </span><span style="color: #F78C6C">length</span><span style="color: #BABED8">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">{street_name}</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">))), </span></span>
<span class="line has-focus"><span style="color: #BABED8">    </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">-</span><span style="color: #BABED8"> (levenshtein(streetname_nl_striped, </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">{street_name}</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">greatest</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">length</span><span style="color: #BABED8">(streetname_nl_striped), </span><span style="color: #F78C6C">length</span><span style="color: #BABED8">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">{street_name}</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">))), </span></span>
<span class="line has-focus"><span style="color: #BABED8">    </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">-</span><span style="color: #BABED8"> (levenshtein(streetname_de_striped, </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">{street_name}</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">greatest</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">length</span><span style="color: #BABED8">(streetname_de_striped), </span><span style="color: #F78C6C">length</span><span style="color: #BABED8">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">{street_name}</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">))) </span></span>
<span class="line has-focus"><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> best_levenshtein_score </span></span>
<span class="line"><span style="color: #BABED8">, </span><span style="color: #82AAFF">greatest</span><span style="color: #BABED8">(</span></span>
<span class="line"><span style="color: #BABED8">    jaro_similarity(streetname_fr_striped, </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">{street_name}</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">    jaro_similarity(streetname_nl_striped, </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">{street_name}</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">    jaro_similarity(streetname_de_striped, </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">{street_name}</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> best_jaro_score</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #89DDFF">=</span><span style="color: #F78C6C">1</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> postcode </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">{postcode}</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line has-focus"><span style="color: #BABED8">    </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> best_jaro_score </span><span style="color: #89DDFF">&gt;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">0</span><span style="color: #BABED8">.</span><span style="color: #F78C6C">6</span><span style="color: #BABED8"> </span></span>
<span class="line"><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> ALL</span></span>
<span class="line has-focus"><span style="color: #F78C6C">ORDER BY</span><span style="color: #BABED8"> best_levenshtein_score </span><span style="color: #F78C6C">DESC</span><span style="color: #BABED8"> </span></span>
<span class="line"><span style="color: #F78C6C">LIMIT</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">3</span><span style="color: #BABED8">;</span></span></code></pre>
</div><p>This query performs several key operations:</p>
<ol>
<li>Strips accents and normalizes street names in all three national languages (French, Dutch, and German)</li>
<li>Calculates Levenshtein distance scores for each language version</li>
<li>Computes Jaro similarity scores as a secondary matching metric</li>
<li>Filters results based on a minimum similarity threshold</li>
<li>Returns the top 3 matches ordered by Levenshtein score</li>
</ol>
<h3 id="application-configuration" tabindex="-1">Application Configuration <a class="header-anchor" href="#application-configuration" aria-label="Permalink to &quot;Application Configuration&quot;">&ZeroWidthSpace;</a></h3>
<p>The API is built with scalability and maintainability in mind:</p>
<div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #C792EA">def</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">get_application</span><span style="color: #89DDFF">()</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">-&gt;</span><span style="color: #BABED8"> FastAPI</span><span style="color: #89DDFF">:</span></span>
<span class="line"><span style="color: #BABED8">    application </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">FastAPI</span><span style="color: #89DDFF">(</span></span>
<span class="line"><span style="color: #82AAFF">        </span><span style="color: #BABED8; font-style: italic">title</span><span style="color: #89DDFF">=</span><span style="color: #82AAFF">metadata</span><span style="color: #89DDFF">.</span><span style="color: #F07178">app_name</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #82AAFF">        </span><span style="color: #BABED8; font-style: italic">description</span><span style="color: #89DDFF">=</span><span style="color: #82AAFF">metadata</span><span style="color: #89DDFF">.</span><span style="color: #F07178">base_description</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #82AAFF">        </span><span style="color: #BABED8; font-style: italic">version</span><span style="color: #89DDFF">=</span><span style="color: #82AAFF">os</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">getenv</span><span style="color: #89DDFF">(</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">CI_COMMIT_SHORT_SHA</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">N/A</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">),</span></span>
<span class="line"><span style="color: #82AAFF">        </span><span style="color: #BABED8; font-style: italic">openapi_tags</span><span style="color: #89DDFF">=</span><span style="color: #82AAFF">metadata</span><span style="color: #89DDFF">.</span><span style="color: #F07178">tags_metadata</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #82AAFF">        </span><span style="color: #BABED8; font-style: italic">contact</span><span style="color: #89DDFF">=</span><span style="color: #82AAFF">metadata</span><span style="color: #89DDFF">.</span><span style="color: #F07178">contact</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #82AAFF">        </span><span style="color: #BABED8; font-style: italic">deployement</span><span style="color: #89DDFF">=</span><span style="color: #82AAFF">metadata</span><span style="color: #89DDFF">.</span><span style="color: #F07178">deployement</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #82AAFF">    </span><span style="color: #89DDFF">)</span></span></code></pre>
</div><h3 id="model-context-protocol-mcp" tabindex="-1">Model-Context-Protocol (MCP) <a class="header-anchor" href="#model-context-protocol-mcp" aria-label="Permalink to &quot;Model-Context-Protocol (MCP)&quot;">&ZeroWidthSpace;</a></h3>
<p>We implemented a Model-Context-Protocol (MCP) pattern using <code>FastApiMCP</code>, to be able to call the API from LLM with tools capabilities.</p>
<div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #BABED8">mcp </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">FastApiMCP</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">app</span><span style="color: #89DDFF">)</span></span></code></pre>
</div><h3 id="performance-considerations" tabindex="-1">Performance Considerations <a class="header-anchor" href="#performance-considerations" aria-label="Permalink to &quot;Performance Considerations&quot;">&ZeroWidthSpace;</a></h3>
<p>The API includes performance monitoring features:</p>
<ul>
<li>Execution time tracking for each request</li>
<li>Batch processing capabilities (up to 25 addresses per request)</li>
<li>Efficient distance calculations using the <code>geopy</code> library (spacial library from DuckDB could also be used)</li>
</ul>
<h3 id="error-handling-and-validation" tabindex="-1">Error Handling and Validation <a class="header-anchor" href="#error-handling-and-validation" aria-label="Permalink to &quot;Error Handling and Validation&quot;">&ZeroWidthSpace;</a></h3>
<p>The API implements robust error handling and input validation:</p>
<ul>
<li>Input validation through Pydantic models</li>
<li>Batch size limitations</li>
<li>Proper error responses for invalid requests</li>
</ul>
<h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">&ZeroWidthSpace;</a></h2>
<p>The HouteSiTrue API provides a robust and efficient solution for address matching and validation in Belgium. By combining strict and fuzzy matching techniques with a well-structured API design, we've created a reliable service that bridges the gap between legacy systems and modern address data requirements.</p>
<p>This API was used to match addresses from our legacy GEOG system with the BestAddress reference dataset. For that we used the <code>bestmatch</code> endpoint in combination with an orchestrator (Dagster).</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Comment savoir si on peut r√©utiliser un calendrier pour une ann√©e donn√©e en SQL ?]]></title>
            <link>localhost/blog/blog/posts/2025/how-to-reuse-a-calendar.html</link>
            <guid>localhost/blog/blog/posts/2025/how-to-reuse-a-calendar.html</guid>
            <pubDate>Wed, 26 Mar 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[<p><strong>Executive summary</strong>: Comment savoir si on peut r√©utiliser un calendrier pour une ann√©e donn√©e en SQL ?</p>
]]></description>
            <content:encoded><![CDATA[<p><strong>Executive summary</strong>: Comment savoir si on peut r√©utiliser un calendrier pour une ann√©e donn√©e en SQL ?</p>
<hr>
<h1 id="comment-savoir-si-on-peut-reutiliser-un-calendrier-pour-une-annee-donnee-en-sql" tabindex="-1">Comment savoir si on peut r√©utiliser un calendrier pour une ann√©e donn√©e en SQL ? <a class="header-anchor" href="#comment-savoir-si-on-peut-reutiliser-un-calendrier-pour-une-annee-donnee-en-sql" aria-label="Permalink to &quot;Comment savoir si on peut r√©utiliser un calendrier pour une ann√©e donn√©e en SQL ?&quot;">&ZeroWidthSpace;</a></h1>
<p>Pour comparer les calendriers de plusieurs ann√©es, on peut suivre la simple logique suivante :</p>
<ul>
<li>Si le 1er janvier et le 1er mars tombent le m√™me jour de la semaine ;</li>
<li>Alors on peut r√©utiliser le calendrier de l'ann√©e pr√©c√©dente.</li>
</ul>
<p>On peut donc g√©n√©rer une cl√© compos√©e de 2 chiffres en base 7 (de <code>0</code> √† <code>6</code>) en fonction du jour de la semaine du 1er janvier et du 1er mars pour chaque ann√©e.</p>
<p>En joignant les calendriers de chaque ann√©e, on peut alors identifier les ann√©es o√π on peut r√©utiliser le calendrier de l'ann√©e pr√©c√©dente.</p>
<p>Et si on essayait de la faire en <strong>SQL</strong> ?</p>
<h2 id="experimentation-en-duckdb" tabindex="-1">Experimentation en DuckDB <a class="header-anchor" href="#experimentation-en-duckdb" aria-label="Permalink to &quot;Experimentation en DuckDB&quot;">&ZeroWidthSpace;</a></h2>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SET</span><span style="color: #BABED8"> VARIABLE start_year </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">2000</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">;</span></span>
<span class="line"><span style="color: #F78C6C">SET</span><span style="color: #BABED8"> VARIABLE end_year </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">2030-12-31</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">::</span><span style="color: #C792EA">date</span><span style="color: #BABED8">;</span></span>
<span class="line"><span style="color: #F78C6C">SET</span><span style="color: #BABED8"> VARIABLE first_jan </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">concat</span><span style="color: #BABED8">(getvariable(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">start_year</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">), </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">-01-01</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">)::</span><span style="color: #C792EA">date</span><span style="color: #BABED8">;</span></span>
<span class="line"><span style="color: #F78C6C">SET</span><span style="color: #BABED8"> VARIABLE first_march </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">concat</span><span style="color: #BABED8">(getvariable(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">start_year</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">), </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">-03-01</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">)::</span><span style="color: #C792EA">date</span><span style="color: #BABED8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F78C6C">WITH</span><span style="color: #BABED8"> t_january </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">YEAR</span><span style="color: #BABED8">(generate_series) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> current_year,</span></span>
<span class="line"><span style="color: #BABED8">        DAYOFWEEK(generate_series) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> wday</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">generate_series</span><span style="color: #BABED8">(</span></span>
<span class="line"><span style="color: #BABED8">        getvariable(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">first_jan</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">        getvariable(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">end_year</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">        INTERVAL </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">year</span></span>
<span class="line"><span style="color: #BABED8">    )</span></span>
<span class="line"><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">t_march </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">YEAR</span><span style="color: #BABED8">(generate_series) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> current_year,</span></span>
<span class="line"><span style="color: #BABED8">        DAYOFWEEK(generate_series) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> wday</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">generate_series</span><span style="color: #BABED8">(</span></span>
<span class="line"><span style="color: #BABED8">        getvariable(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">first_march</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">        getvariable(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">end_year</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">        INTERVAL </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">year</span></span>
<span class="line"><span style="color: #BABED8">    )</span></span>
<span class="line"><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">key_by_year </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">        t_january.current_year,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">concat</span><span style="color: #BABED8">(t_january.wday, t_march.wday) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> wday_key</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> t_january</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">JOIN</span><span style="color: #BABED8"> t_march</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #F78C6C">ON</span><span style="color: #BABED8"> t_january.current_year </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> t_march.current_year</span></span>
<span class="line"><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">calendars_joined </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">        k1.current_year,</span></span>
<span class="line"><span style="color: #BABED8">        k1.wday_key,</span></span>
<span class="line"><span style="color: #BABED8">        k2.current_year </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> compatible_year,</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> key_by_year </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> k1</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">JOIN</span><span style="color: #BABED8"> key_by_year </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> k2</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #F78C6C">ON</span><span style="color: #BABED8"> k1.wday_key </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> k2.wday_key</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> k1.current_year </span><span style="color: #89DDFF">!=</span><span style="color: #BABED8"> k2.current_year</span></span>
<span class="line"><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">    current_year,</span></span>
<span class="line"><span style="color: #BABED8">    array_agg(compatible_year </span><span style="color: #F78C6C">ORDER BY</span><span style="color: #BABED8"> compatible_year) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> same_wday_years</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> calendars_joined</span></span>
<span class="line"><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> current_year</span></span>
<span class="line"><span style="color: #F78C6C">ORDER BY</span><span style="color: #BABED8"> current_year;</span></span></code></pre>
</div><h1 id="et-voila" tabindex="-1">Et voil√† ! üéâ <a class="header-anchor" href="#et-voila" aria-label="Permalink to &quot;Et voil√† ! :tada:&quot;">&ZeroWidthSpace;</a></h1>
<table>
<thead>
<tr>
<th style="text-align:right">current_year</th>
<th>same_wday_years</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">2000</td>
<td>[2028]</td>
</tr>
<tr>
<td style="text-align:right">2001</td>
<td>[2007, 2018, 2029]</td>
</tr>
<tr>
<td style="text-align:right">2002</td>
<td>[2013, 2019, 2030]</td>
</tr>
<tr>
<td style="text-align:right">2003</td>
<td>[2014, 2025]</td>
</tr>
<tr>
<td style="text-align:right">2005</td>
<td>[2011, 2022]</td>
</tr>
<tr>
<td style="text-align:right">2006</td>
<td>[2017, 2023]</td>
</tr>
<tr>
<td style="text-align:right">2007</td>
<td>[2001, 2018, 2029]</td>
</tr>
<tr>
<td style="text-align:right">2009</td>
<td>[2015, 2026]</td>
</tr>
<tr>
<td style="text-align:right">2010</td>
<td>[2021, 2027]</td>
</tr>
<tr>
<td style="text-align:right">2011</td>
<td>[2005, 2022]</td>
</tr>
<tr>
<td style="text-align:right">2013</td>
<td>[2002, 2019, 2030]</td>
</tr>
<tr>
<td style="text-align:right">2014</td>
<td>[2003, 2025]</td>
</tr>
<tr>
<td style="text-align:right">2015</td>
<td>[2009, 2026]</td>
</tr>
<tr>
<td style="text-align:right">2017</td>
<td>[2006, 2023]</td>
</tr>
<tr>
<td style="text-align:right">2018</td>
<td>[2001, 2007, 2029]</td>
</tr>
<tr>
<td style="text-align:right">2019</td>
<td>[2002, 2013, 2030]</td>
</tr>
<tr>
<td style="text-align:right">2021</td>
<td>[2010, 2027]</td>
</tr>
<tr>
<td style="text-align:right">2022</td>
<td>[2005, 2011]</td>
</tr>
<tr>
<td style="text-align:right">2023</td>
<td>[2006, 2017]</td>
</tr>
<tr>
<td style="text-align:right">2025</td>
<td>[2003, 2014]</td>
</tr>
<tr>
<td style="text-align:right">2026</td>
<td>[2009, 2015]</td>
</tr>
<tr>
<td style="text-align:right">2027</td>
<td>[2010, 2021]</td>
</tr>
<tr>
<td style="text-align:right">2028</td>
<td>[2000]</td>
</tr>
<tr>
<td style="text-align:right">2029</td>
<td>[2001, 2007, 2018]</td>
</tr>
<tr>
<td style="text-align:right">2030</td>
<td>[2002, 2013, 2019]</td>
</tr>
</tbody>
</table>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Address lookup - Part 2b: Messing around]]></title>
            <link>localhost/blog/blog/posts/2024/address_lookup-part2b-messing-around.html</link>
            <guid>localhost/blog/blog/posts/2024/address_lookup-part2b-messing-around.html</guid>
            <pubDate>Tue, 03 Dec 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[<p><em>Executive summary</em>: In Belgium, a collaborative effort between regional and federal authorities has led to the creation of a unified service that aggregates all Belgian addresses into a comprehensive dataset. This dataset is called <a href="https://bosa.belgium.be/fr/services/best-address-services" target="_blank" rel="noreferrer">BeStAddress</a>.</p>
]]></description>
            <content:encoded><![CDATA[<p><em>Executive summary</em>: In Belgium, a collaborative effort between regional and federal authorities has led to the creation of a unified service that aggregates all Belgian addresses into a comprehensive dataset. This dataset is called <a href="https://bosa.belgium.be/fr/services/best-address-services" target="_blank" rel="noreferrer">BeStAddress</a>.</p>
<hr>
<h1 id="address-lookup-part-2b-messing-around" tabindex="-1">Address lookup - Part 2b: Messing around <a class="header-anchor" href="#address-lookup-part-2b-messing-around" aria-label="Permalink to &quot;Address lookup - Part 2b: Messing around&quot;">&ZeroWidthSpace;</a></h1>
<p>This post is a continuation of the <a href="/blog/posts/2024/address_lookup-part2-sourcing.html">previous post</a> where we have analyzed the data model of the BeStAddress dataset.</p>
<h2 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">&ZeroWidthSpace;</a></h2>
<p>In Belgium, each municipality is responsible for naming its streets. <a href="https://www.ibz.rrn.fgov.be/fileadmin/user_upload/fr/rn/circulaires/BeSt_20201104_F.pdf" target="_blank" rel="noreferrer">Although it is recommended to avoid similar street names</a>, this can sometimes result in two streets within the same municipality having very similar names. In this post, we will explore the <strong>BeStAddress dataset</strong> to identify pairs of streets with similar names that are geographically close to each other.</p>
<p>To analyse this, we will use the <a href="/blog/posts/2024/address_lookup-part2-sourcing.html">unified table that aggregates all the data from the different regions of Belgium</a> to find pairs of streets with similar names that are close to each other.</p>
<p>We will proceed in three steps:</p>
<ol>
<li>Find the average latitude and longitude of each street in each municipality.</li>
<li>Calculate the distance between each pair of streets in the same municipality.</li>
<li>Calculate the Levenshtein distance between the street names of each pair of streets.</li>
</ol>
<h2 id="step-1-find-the-average-latitude-and-longitude-of-street-in-each-municipality" tabindex="-1">Step 1: Find the average latitude and longitude of street in each municipality <a class="header-anchor" href="#step-1-find-the-average-latitude-and-longitude-of-street-in-each-municipality" aria-label="Permalink to &quot;Step 1: Find the average latitude and longitude of street in each municipality&quot;">&ZeroWidthSpace;</a></h2>
<p>This step will allow us to identify the geographical center of each street in the dataset and then use this information to calculate the distance between pairs of streets.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">WITH</span><span style="color: #BABED8"> averages_by_streets </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">             street_id,</span></span>
<span class="line"><span style="color: #BABED8">             </span><span style="color: #82AAFF">round</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">AVG</span><span style="color: #BABED8">(latitude), </span><span style="color: #F78C6C">4</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> latitude,</span></span>
<span class="line"><span style="color: #BABED8">             </span><span style="color: #82AAFF">round</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">AVG</span><span style="color: #BABED8">(longitude), </span><span style="color: #F78C6C">4</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> longitude,</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> municipality_id, street_id</span></span>
<span class="line"><span style="color: #BABED8">  )</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> averages_by_streets</span></span></code></pre>
</div><h2 id="step-2-distance-calculation" tabindex="-1">Step 2. Distance Calculation <a class="header-anchor" href="#step-2-distance-calculation" aria-label="Permalink to &quot;Step 2. Distance Calculation&quot;">&ZeroWidthSpace;</a></h2>
<p>We will calculate the distance between each pair of streets in the same municipality. We will use the <strong>Haversine formula</strong> to calculate the distance between two points on the Earth's surface given their latitude and longitude.</p>
<p>After calculating the distance between each pair of streets, we will filter the results to only include pairs of streets that are less than 5 kilometers apart.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">WITH</span><span style="color: #BABED8"> averages_by_streets </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">             street_id,</span></span>
<span class="line"><span style="color: #BABED8">             </span><span style="color: #82AAFF">round</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">AVG</span><span style="color: #BABED8">(latitude), </span><span style="color: #F78C6C">4</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> latitude,</span></span>
<span class="line"><span style="color: #BABED8">             </span><span style="color: #82AAFF">round</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">AVG</span><span style="color: #BABED8">(longitude), </span><span style="color: #F78C6C">4</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> longitude,</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> postcode </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">4140</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #676E95; font-style: italic">-- Filter by municipality_id == Sprimont</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> municipality_id, street_id</span></span>
<span class="line"><span style="color: #BABED8">  ),</span></span>
<span class="line"><span style="color: #BABED8">combination_streets </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> a.municipality_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_id_1,</span></span>
<span class="line"><span style="color: #BABED8">           a.street_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> street_id_1,</span></span>
<span class="line"><span style="color: #BABED8">           a.latitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> lat1,</span></span>
<span class="line"><span style="color: #BABED8">           a.longitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> lon1,</span></span>
<span class="line"><span style="color: #BABED8">           b.municipality_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_id_2,</span></span>
<span class="line"><span style="color: #BABED8">           b.street_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> street_id_2,</span></span>
<span class="line"><span style="color: #BABED8">           b.latitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> lat2,</span></span>
<span class="line"><span style="color: #BABED8">           b.longitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> lon2</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> averages_by_streets a</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">CROSS JOIN</span><span style="color: #BABED8"> averages_by_streets b</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> (a.municipality_id, a.street_id) </span><span style="color: #89DDFF">&lt;&gt;</span><span style="color: #BABED8"> (b.municipality_id, b.street_id) </span><span style="color: #676E95; font-style: italic">-- Exclude self-joins</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> (a.municipality_id </span><span style="color: #89DDFF">&lt;</span><span style="color: #BABED8"> b.municipality_id</span></span>
<span class="line"><span style="color: #BABED8">           </span><span style="color: #F78C6C">OR</span><span style="color: #BABED8"> (a.municipality_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> b.municipality_id </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> a.street_id </span><span style="color: #89DDFF">&lt;</span><span style="color: #BABED8"> b.street_id)</span></span>
<span class="line"><span style="color: #BABED8">        )  </span><span style="color: #676E95; font-style: italic">-- Ensure unique pairs</span></span>
<span class="line"><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">distance_calculation </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> municipality_id_1,</span></span>
<span class="line"><span style="color: #BABED8">           street_id_1,</span></span>
<span class="line"><span style="color: #BABED8">           municipality_id_2,</span></span>
<span class="line"><span style="color: #BABED8">           street_id_2,</span></span>
<span class="line"><span style="color: #89DDFF">           </span><span style="color: #676E95; font-style: italic">-- Haversine Formula</span></span>
<span class="line"><span style="color: #89DDFF">           </span><span style="color: #676E95; font-style: italic">-- 6371 is the radius of the Earth in kilometers</span></span>
<span class="line"><span style="color: #89DDFF">           </span><span style="color: #676E95; font-style: italic">-- RADIANS converts degrees to radians</span></span>
<span class="line"><span style="color: #BABED8">           </span><span style="color: #F78C6C">6371</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">2</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">ASIN</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">SQRT</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">POWER</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">SIN</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">RADIANS</span><span style="color: #BABED8">(lat2 </span><span style="color: #89DDFF">-</span><span style="color: #BABED8"> lat1) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">2</span><span style="color: #BABED8">), </span><span style="color: #F78C6C">2</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">+</span></span>
<span class="line"><span style="color: #BABED8">                                </span><span style="color: #82AAFF">COS</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">RADIANS</span><span style="color: #BABED8">(lat1)) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">COS</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">RADIANS</span><span style="color: #BABED8">(lat2)) </span><span style="color: #89DDFF">*</span></span>
<span class="line"><span style="color: #BABED8">                                </span><span style="color: #82AAFF">POWER</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">SIN</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">RADIANS</span><span style="color: #BABED8">(lon2 </span><span style="color: #89DDFF">-</span><span style="color: #BABED8"> lon1) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">2</span><span style="color: #BABED8">), </span><span style="color: #F78C6C">2</span><span style="color: #BABED8">))) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> distance_km</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> combination_streets</span></span>
<span class="line"><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> municipality_id_1,</span></span>
<span class="line"><span style="color: #BABED8">       street_id_1,</span></span>
<span class="line"><span style="color: #BABED8">       municipality_id_2,</span></span>
<span class="line"><span style="color: #BABED8">       street_id_2,</span></span>
<span class="line"><span style="color: #BABED8">       </span><span style="color: #82AAFF">round</span><span style="color: #BABED8">(distance_km, </span><span style="color: #F78C6C">2</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> distance_km</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> distance_calculation</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> distance_km </span><span style="color: #89DDFF">&lt;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">5</span><span style="color: #BABED8">;</span></span></code></pre>
</div><h2 id="step-3-levenshtein-distance-calculation" tabindex="-1">Step 3. Levenshtein Distance Calculation <a class="header-anchor" href="#step-3-levenshtein-distance-calculation" aria-label="Permalink to &quot;Step 3. Levenshtein Distance Calculation&quot;">&ZeroWidthSpace;</a></h2>
<p>Finally, we will calculate the Levenshtein distance between the street names of each pair of streets. The Levenshtein distance is a measure of the similarity between two strings. It is defined as the minimum number of single-character edits (insertions, deletions, or substitutions) required to change one string into the other.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">WITH</span><span style="color: #BABED8"> averages_by_streets </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">             street_id,</span></span>
<span class="line"><span style="color: #BABED8">             </span><span style="color: #82AAFF">round</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">AVG</span><span style="color: #BABED8">(latitude), </span><span style="color: #F78C6C">4</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> latitude,</span></span>
<span class="line"><span style="color: #BABED8">             </span><span style="color: #82AAFF">round</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">AVG</span><span style="color: #BABED8">(longitude), </span><span style="color: #F78C6C">4</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> longitude,</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> postcode </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">4140</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #676E95; font-style: italic">-- Filter by municipality_id == Sprimont</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> municipality_id, street_id</span></span>
<span class="line"><span style="color: #BABED8">  ),</span></span>
<span class="line"><span style="color: #BABED8">unique_streetname </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">           street_id,</span></span>
<span class="line"><span style="color: #BABED8">           default_streetname</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #89DDFF">=</span><span style="color: #F78C6C">1</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> street_id </span><span style="color: #F78C6C">IN</span><span style="color: #BABED8"> (</span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> street_id </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> averages_by_streets)</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> municipality_id </span><span style="color: #F78C6C">IN</span><span style="color: #BABED8"> (</span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> municipality_id </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> averages_by_streets)</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> ALL</span></span>
<span class="line"><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">combination_streets </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> a.municipality_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_id_1,</span></span>
<span class="line"><span style="color: #BABED8">           a.street_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> street_id_1,</span></span>
<span class="line"><span style="color: #BABED8">           a.latitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> lat1,</span></span>
<span class="line"><span style="color: #BABED8">           a.longitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> lon1,</span></span>
<span class="line"><span style="color: #BABED8">           b.municipality_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_id_2,</span></span>
<span class="line"><span style="color: #BABED8">           b.street_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> street_id_2,</span></span>
<span class="line"><span style="color: #BABED8">           b.latitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> lat2,</span></span>
<span class="line"><span style="color: #BABED8">           b.longitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> lon2</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> averages_by_streets a</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">CROSS JOIN</span><span style="color: #BABED8"> averages_by_streets b</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> (a.municipality_id, a.street_id) </span><span style="color: #89DDFF">&lt;&gt;</span><span style="color: #BABED8"> (b.municipality_id, b.street_id) </span><span style="color: #676E95; font-style: italic">-- Exclude self-joins</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> (a.municipality_id </span><span style="color: #89DDFF">&lt;</span><span style="color: #BABED8"> b.municipality_id</span></span>
<span class="line"><span style="color: #BABED8">           </span><span style="color: #F78C6C">OR</span><span style="color: #BABED8"> (a.municipality_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> b.municipality_id </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> a.street_id </span><span style="color: #89DDFF">&lt;</span><span style="color: #BABED8"> b.street_id)</span></span>
<span class="line"><span style="color: #BABED8">        )  </span><span style="color: #676E95; font-style: italic">-- Ensure unique pairs</span></span>
<span class="line"><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">distance_calculation </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> municipality_id_1,</span></span>
<span class="line"><span style="color: #BABED8">           street_id_1,</span></span>
<span class="line"><span style="color: #BABED8">           municipality_id_2,</span></span>
<span class="line"><span style="color: #BABED8">           street_id_2,</span></span>
<span class="line"><span style="color: #89DDFF">           </span><span style="color: #676E95; font-style: italic">-- Haversine Formula</span></span>
<span class="line"><span style="color: #89DDFF">           </span><span style="color: #676E95; font-style: italic">-- 6371 is the radius of the Earth in kilometers</span></span>
<span class="line"><span style="color: #89DDFF">           </span><span style="color: #676E95; font-style: italic">-- RADIANS converts degrees to radians</span></span>
<span class="line"><span style="color: #BABED8">           </span><span style="color: #F78C6C">6371</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">2</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">ASIN</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">SQRT</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">POWER</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">SIN</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">RADIANS</span><span style="color: #BABED8">(lat2 </span><span style="color: #89DDFF">-</span><span style="color: #BABED8"> lat1) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">2</span><span style="color: #BABED8">), </span><span style="color: #F78C6C">2</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">+</span></span>
<span class="line"><span style="color: #BABED8">                                </span><span style="color: #82AAFF">COS</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">RADIANS</span><span style="color: #BABED8">(lat1)) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">COS</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">RADIANS</span><span style="color: #BABED8">(lat2)) </span><span style="color: #89DDFF">*</span></span>
<span class="line"><span style="color: #BABED8">                                </span><span style="color: #82AAFF">POWER</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">SIN</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">RADIANS</span><span style="color: #BABED8">(lon2 </span><span style="color: #89DDFF">-</span><span style="color: #BABED8"> lon1) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">2</span><span style="color: #BABED8">), </span><span style="color: #F78C6C">2</span><span style="color: #BABED8">))) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> distance_km</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> combination_streets</span></span>
<span class="line"><span style="color: #BABED8">), combination_with_distances_filtered </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> municipality_id_1,</span></span>
<span class="line"><span style="color: #BABED8">       street_id_1,</span></span>
<span class="line"><span style="color: #BABED8">       municipality_id_2,</span></span>
<span class="line"><span style="color: #BABED8">       street_id_2,</span></span>
<span class="line"><span style="color: #BABED8">       </span><span style="color: #82AAFF">round</span><span style="color: #BABED8">(distance_km, </span><span style="color: #F78C6C">2</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> distance_km</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> distance_calculation</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> distance_km </span><span style="color: #89DDFF">&lt;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">5</span></span>
<span class="line"><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">levenstein_distance </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">    municipality_id_1,</span></span>
<span class="line"><span style="color: #BABED8">    street_id_1,</span></span>
<span class="line"><span style="color: #BABED8">    municipality_id_2,</span></span>
<span class="line"><span style="color: #BABED8">    street_id_2,</span></span>
<span class="line"><span style="color: #BABED8">    distance_km,</span></span>
<span class="line"><span style="color: #BABED8">    a.default_streetname </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> streetname_1,</span></span>
<span class="line"><span style="color: #BABED8">    b.default_streetname </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> streetname_2,</span></span>
<span class="line"><span style="color: #BABED8">    levenshtein(a.default_streetname, b.default_streetname) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> levenshtein_distance</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> combination_with_distances_filtered</span></span>
<span class="line"><span style="color: #F78C6C">LEFT JOIN</span><span style="color: #BABED8"> unique_streetname </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> a</span></span>
<span class="line"><span style="color: #BABED8">   </span><span style="color: #F78C6C">ON</span><span style="color: #BABED8"> a.municipality_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> municipality_id_1</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> a.street_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> street_id_1</span></span>
<span class="line"><span style="color: #F78C6C">LEFT JOIN</span><span style="color: #BABED8"> unique_streetname </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> b</span></span>
<span class="line"><span style="color: #BABED8">   </span><span style="color: #F78C6C">ON</span><span style="color: #BABED8"> b.municipality_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> municipality_id_2</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> b.street_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> street_id_2</span></span>
<span class="line"><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> levenstein_distance</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #89DDFF">=</span><span style="color: #F78C6C">1</span></span>
<span class="line"><span style="color: #BABED8">   </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> levenshtein_distance </span><span style="color: #89DDFF">&lt;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">10</span></span>
<span class="line"><span style="color: #BABED8">   </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> levenshtein_distance </span><span style="color: #89DDFF">&gt;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">0</span></span>
<span class="line"><span style="color: #F78C6C">ORDER BY</span><span style="color: #BABED8"> levenshtein_distance, distance_km;</span></span></code></pre>
</div><p>That's it! We have successfully identified pairs of streets with similar names that are geographically close to each other. It is a long query, but it is very powerful and can be used to identify potential issues with street names in the BeStAddress dataset.</p>
<h2 id="results" tabindex="-1">Results <a class="header-anchor" href="#results" aria-label="Permalink to &quot;Results&quot;">&ZeroWidthSpace;</a></h2>
<table>
<thead>
<tr>
<th style="text-align:right">municipality_id_1</th>
<th style="text-align:right">street_id_1</th>
<th style="text-align:right">municipality_id_2</th>
<th style="text-align:right">street_id_2</th>
<th style="text-align:right">distance_km</th>
<th>streetname_1</th>
<th>streetname_2</th>
<th style="text-align:right">levenshtein_distance</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7732983</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7732991</td>
<td style="text-align:right">4.16</td>
<td>Rue de Damr√©</td>
<td>Rue de Gomz√©</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7732996</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733018</td>
<td style="text-align:right">2.53</td>
<td>Rue de la Carri√®re</td>
<td>Rue de la Sabli√®re</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733062</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733067</td>
<td style="text-align:right">0.63</td>
<td>Rue des Fawes</td>
<td>Rue des Marets</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733110</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733117</td>
<td style="text-align:right">3.48</td>
<td>Rue du Roua</td>
<td>Rue du Vou√©</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7732981</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733047</td>
<td style="text-align:right">4.02</td>
<td>Rue de Coreux</td>
<td>Rue de Theux</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7732981</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733042</td>
<td style="text-align:right">1.13</td>
<td>Rue de Coreux</td>
<td>Rue de Rouvreux</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7732961</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733129</td>
<td style="text-align:right">0.27</td>
<td>Rue Basse Lill√©</td>
<td>Rue Haute Lill√©</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733092</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733108</td>
<td style="text-align:right">4.55</td>
<td>Rue du Coq</td>
<td>Rue du Pont</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733105</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7762862</td>
<td style="text-align:right">0.33</td>
<td>Rue du Pahy</td>
<td>Rue du Parc</td>
<td style="text-align:right">2</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733124</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733132</td>
<td style="text-align:right">4.37</td>
<td>Rue Ferreuse</td>
<td>Rue Houreuse</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733123</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733124</td>
<td style="text-align:right">3.9</td>
<td>Rue Ferrer</td>
<td>Rue Ferreuse</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733081</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7762862</td>
<td style="text-align:right">2.6</td>
<td>Rue du Baron</td>
<td>Rue du Parc</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733083</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7762862</td>
<td style="text-align:right">1.66</td>
<td>Rue du Baty</td>
<td>Rue du Parc</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733083</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733105</td>
<td style="text-align:right">1.99</td>
<td>Rue du Baty</td>
<td>Rue du Pahy</td>
<td style="text-align:right">2</td>
</tr>
<tr>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733081</td>
<td style="text-align:right">62100</td>
<td style="text-align:right">7733083</td>
<td style="text-align:right">3.85</td>
<td>Rue du Baron</td>
<td>Rue du Baty</td>
<td style="text-align:right">3</td>
</tr>
</tbody>
</table>
<h2 id="further-exploration" tabindex="-1">Further exploration <a class="header-anchor" href="#further-exploration" aria-label="Permalink to &quot;Further exploration&quot;">&ZeroWidthSpace;</a></h2>
<ImageCenter src="https://i.giphy.com/media/v1.Y2lkPTc5MGI3NjExZTZ6NW5nbXU2Z3hudGszMDljM2lodjR3bHJyZ3Zva3VvZTF5Z3ZqYyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/KEXq9JVp3OyZmxZw0W/giphy.gif" alt="Further exploration" width="800" /><p>This dataset is rich in information and can be used to answer a wide range of questions. Here are a few examples of other queries that can be run on the BeStAddress dataset:</p>
<h3 id="finding-all-unique-combinations-of-two-different-street-id-within-the-same-municipality-id" tabindex="-1">Finding all unique combinations of two different street_id within the same municipality_id <a class="header-anchor" href="#finding-all-unique-combinations-of-two-different-street-id-within-the-same-municipality-id" aria-label="Permalink to &quot;Finding all unique combinations of two different street_id within the same municipality_id&quot;">&ZeroWidthSpace;</a></h3>
<p>To retrieve all unique combinations of two different street IDs within the same municipality_id from a SQL database, you can use a self-join. A self-join allows you to pair rows from the same table where certain conditions are met (in this case, two differents street IDs but the same municipality ID).</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight has-diff" ><code><span class="line"><span style="color: #F78C6C">WITH</span><span style="color: #BABED8"> DistinctStreets </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">        municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">        street_id,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">round</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">avg</span><span style="color: #BABED8">(latitude), </span><span style="color: #F78C6C">3</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> latitude, </span><span style="color: #676E95; font-style: italic">-- Round to 3 decimal places (= ~110 meters)</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">round</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">avg</span><span style="color: #BABED8">(longitude), </span><span style="color: #F78C6C">3</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> longitude</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span></span>
<span class="line"><span style="color: #BABED8">        bestAddress</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">GROUP BY</span></span>
<span class="line"><span style="color: #BABED8">        municipality_id, street_id</span></span>
<span class="line"><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">    a.municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">    a.street_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> first_street_id,</span></span>
<span class="line"><span style="color: #BABED8">    b.street_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> second_street_id,</span></span>
<span class="line"><span style="color: #BABED8">    a.latitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> first_street_latitude,</span></span>
<span class="line"><span style="color: #BABED8">    a.longitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> first_street_longitude,</span></span>
<span class="line"><span style="color: #BABED8">    b.latitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> second_street_latitude,</span></span>
<span class="line"><span style="color: #BABED8">    b.longitude </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> second_street_longitude</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span></span>
<span class="line"><span style="color: #BABED8">    DistinctStreets </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> a</span></span>
<span class="line"><span style="color: #F78C6C">JOIN</span></span>
<span class="line"><span style="color: #BABED8">    DistinctStreets </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> b</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">ON</span><span style="color: #BABED8"> a.municipality_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> b.municipality_id </span><span style="color: #676E95; font-style: italic">-- Same municipality</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> a.street_id </span><span style="color: #89DDFF">&lt;</span><span style="color: #BABED8"> b.street_id </span><span style="color: #676E95; font-style: italic">-- Ensure different street ids and avoid duplicate combinations (like (1, 2) and (2, 1))</span></span>
<span class="line"><span style="color: #F78C6C">ORDER BY</span></span>
<span class="line"><span style="color: #BABED8">    a.municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">    a.street_id,</span></span>
<span class="line"><span style="color: #BABED8">    b.street_id</span></span>
<span class="line"><span style="color: #F78C6C">LIMIT</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">;</span></span></code></pre>
</div><h3 id="percentage-of-non-null-streetname-fr-streetname-de-and-streetname-nl-per-municipality" tabindex="-1">Percentage of non-NULL streetname_fr, streetname_de, and streetname_nl per municipality <a class="header-anchor" href="#percentage-of-non-null-streetname-fr-streetname-de-and-streetname-nl-per-municipality" aria-label="Permalink to &quot;Percentage of non-NULL streetname_fr, streetname_de, and streetname_nl per municipality&quot;">&ZeroWidthSpace;</a></h3>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">WITH</span><span style="color: #BABED8"> DistinctStreets </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> municipality_id, street_id, streetname_fr, streetname_de, streetname_nl</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span></span>
<span class="line"><span style="color: #BABED8">        BestAddress</span></span>
<span class="line"><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">    municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> total_streets,  </span><span style="color: #676E95; font-style: italic">-- Total number of distinct streets per municipality</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF">    </span><span style="color: #676E95; font-style: italic">-- Percentage of non-NULL streetname_fr</span></span>
<span class="line"><span style="color: #BABED8">    (</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">CASE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">WHEN</span><span style="color: #BABED8"> streetname_fr </span><span style="color: #F78C6C">IS NOT NULL</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">THEN</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">END</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #89DDFF">/</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">CAST</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> pct_streetname_fr,</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF">    </span><span style="color: #676E95; font-style: italic">-- Percentage of non-NULL streetname_de</span></span>
<span class="line"><span style="color: #BABED8">    (</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">CASE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">WHEN</span><span style="color: #BABED8"> streetname_de </span><span style="color: #F78C6C">IS NOT NULL</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">THEN</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">END</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #89DDFF">/</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">CAST</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> pct_streetname_de,</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF">    </span><span style="color: #676E95; font-style: italic">-- Percentage of non-NULL streetname_nl</span></span>
<span class="line"><span style="color: #BABED8">    (</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">CASE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">WHEN</span><span style="color: #BABED8"> streetname_nl </span><span style="color: #F78C6C">IS NOT NULL</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">THEN</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">END</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #89DDFF">/</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">CAST</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> pct_streetname_nl</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F78C6C">FROM</span></span>
<span class="line"><span style="color: #BABED8">    DistinctStreets</span></span>
<span class="line"><span style="color: #F78C6C">GROUP BY</span></span>
<span class="line"><span style="color: #BABED8">    municipality_id;</span></span></code></pre>
</div><h3 id="percentage-of-non-null-streetname-fr-streetname-de-and-streetname-nl-per-municipality-excluding-municipalities-where-any-of-the-streetname-percentages-are-0-or-100" tabindex="-1">Percentage of non-NULL streetname_fr, streetname_de, and streetname_nl per municipality, excluding municipalities where any of the streetname percentages are 0 or 100 <a class="header-anchor" href="#percentage-of-non-null-streetname-fr-streetname-de-and-streetname-nl-per-municipality-excluding-municipalities-where-any-of-the-streetname-percentages-are-0-or-100" aria-label="Permalink to &quot;Percentage of non-NULL streetname_fr, streetname_de, and streetname_nl per municipality, excluding municipalities where any of the streetname percentages are 0 or 100&quot;">&ZeroWidthSpace;</a></h3>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">WITH</span><span style="color: #BABED8"> DistinctStreets </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">          </span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> municipality_id, street_id, streetname_fr, streetname_de, streetname_nl, region_code</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">FROM</span></span>
<span class="line"><span style="color: #BABED8">          BestAddress</span></span>
<span class="line"><span style="color: #BABED8">  )</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">      municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">      region_code,</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> total_streets,  </span><span style="color: #676E95; font-style: italic">-- Total number of distinct streets per municipality</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF">      </span><span style="color: #676E95; font-style: italic">-- Percentage of non-NULL streetname_fr</span></span>
<span class="line"><span style="color: #BABED8">      (</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">CASE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">WHEN</span><span style="color: #BABED8"> streetname_fr </span><span style="color: #F78C6C">IS NOT NULL</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">THEN</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">END</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">CAST</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> pct_streetname_fr,</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF">      </span><span style="color: #676E95; font-style: italic">-- Percentage of non-NULL streetname_de</span></span>
<span class="line"><span style="color: #BABED8">      (</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">CASE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">WHEN</span><span style="color: #BABED8"> streetname_de </span><span style="color: #F78C6C">IS NOT NULL</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">THEN</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">END</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">CAST</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> pct_streetname_de,</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF">      </span><span style="color: #676E95; font-style: italic">-- Percentage of non-NULL streetname_nl</span></span>
<span class="line"><span style="color: #BABED8">      (</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">CASE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">WHEN</span><span style="color: #BABED8"> streetname_nl </span><span style="color: #F78C6C">IS NOT NULL</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">THEN</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">END</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">CAST</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> pct_streetname_nl</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #F78C6C">FROM</span></span>
<span class="line"><span style="color: #BABED8">      DistinctStreets</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #F78C6C">GROUP BY</span></span>
<span class="line"><span style="color: #BABED8">      municipality_id, region_code</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #F78C6C">HAVING</span></span>
<span class="line"><span style="color: #89DDFF">      </span><span style="color: #676E95; font-style: italic">-- Filter municipalities where any of the streetname percentages are not 0 or 100</span></span>
<span class="line"><span style="color: #BABED8">      (</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">CASE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">WHEN</span><span style="color: #BABED8"> streetname_fr </span><span style="color: #F78C6C">IS NOT NULL</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">THEN</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">END</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">CAST</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">NOT</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">IN</span><span style="color: #BABED8"> (</span><span style="color: #F78C6C">0</span><span style="color: #BABED8">, </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">OR</span><span style="color: #BABED8"> (</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">CASE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">WHEN</span><span style="color: #BABED8"> streetname_de </span><span style="color: #F78C6C">IS NOT NULL</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">THEN</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">END</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">CAST</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">NOT</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">IN</span><span style="color: #BABED8"> (</span><span style="color: #F78C6C">0</span><span style="color: #BABED8">, </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">OR</span><span style="color: #BABED8"> (</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">CASE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">WHEN</span><span style="color: #BABED8"> streetname_nl </span><span style="color: #F78C6C">IS NOT NULL</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">THEN</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">END</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">/</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">CAST</span><span style="color: #BABED8">(</span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">) </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">NOT</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">IN</span><span style="color: #BABED8"> (</span><span style="color: #F78C6C">0</span><span style="color: #BABED8">, </span><span style="color: #F78C6C">100</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #F78C6C">ORDER BY</span></span>
<span class="line"><span style="color: #BABED8">      region_code;</span></span></code></pre>
</div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Address lookup - Part 2 - Sourcing]]></title>
            <link>localhost/blog/blog/posts/2024/address_lookup-part2-sourcing.html</link>
            <guid>localhost/blog/blog/posts/2024/address_lookup-part2-sourcing.html</guid>
            <pubDate>Fri, 01 Nov 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[<p><em>Executive summary</em>: In Belgium, a collaborative effort between regional and federal authorities has led to the creation of a unified service that aggregates all Belgian addresses into a comprehensive dataset. This dataset is called <a href="https://bosa.belgium.be/fr/services/best-address-services" target="_blank" rel="noreferrer">BeStAddress</a>.</p>
]]></description>
            <content:encoded><![CDATA[<p><em>Executive summary</em>: In Belgium, a collaborative effort between regional and federal authorities has led to the creation of a unified service that aggregates all Belgian addresses into a comprehensive dataset. This dataset is called <a href="https://bosa.belgium.be/fr/services/best-address-services" target="_blank" rel="noreferrer">BeStAddress</a>.</p>
<hr>
<h1 id="address-lookup-sourcing-2" tabindex="-1">Address lookup - Sourcing (2) <a class="header-anchor" href="#address-lookup-sourcing-2" aria-label="Permalink to &quot;Address lookup - Sourcing (2)&quot;">&ZeroWidthSpace;</a></h1>
<h2 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">&ZeroWidthSpace;</a></h2>
<p>In the <a href="/blog/posts/2024/address_lookup-part1-problematic.html">previous post</a>, we have analyzed the data model of the BeStAddress dataset. In this post, we will focus on building a unified table that aggregates all the data from the different regions of Belgium. It will be the first step to build an address lookup service.</p>
<h2 id="sources" tabindex="-1">Sources <a class="header-anchor" href="#sources" aria-label="Permalink to &quot;Sources&quot;">&ZeroWidthSpace;</a></h2>
<p>The BeStAddress dataset is composed of different tables. For facilitating the exploration, we used the CSV files provided by the BeStAddress service. XML and Web service is also available -- however XML is harder to parse and the API needs to register and get an API key.</p>
<p>The data is split into three regions:</p>
<ul>
<li>BeVlg: Flanders</li>
<li>BeBru: Brussels</li>
<li>BeWal: Wallonia</li>
</ul>
<p>As shown in the previous article, the data model is similar for the three regions -- but the model is not very obvious. For this reason, we will create a unified table that will be easier to work with. The concept of <a href="https://dataengineering.wiki/Concepts/One+Big+Table" target="_blank" rel="noreferrer"><strong>One Big Table</strong></a> designs are amazing for performance in analytics (expecially with OLAP system) but can be a <a href="/blog/posts/2024/address_lookup-part1-problematic.html">nightmare for data analysis and data quality</a>.</p>
<h2 id="downloading-the-data" tabindex="-1">Downloading the data <a class="header-anchor" href="#downloading-the-data" aria-label="Permalink to &quot;Downloading the data&quot;">&ZeroWidthSpace;</a></h2>
<p>We will use <strong><a href="https://dagster.io" target="_blank" rel="noreferrer">Dagster</a></strong> to download the data and <strong><a href="https://duckdb.org" target="_blank" rel="noreferrer">DuckDB</a></strong> create the big table. Using Dagster will allow us to define a pipeline that will download the data from the different regions and store it in a local database. It will be easy to run the pipeline again if we need to update the data and we can also use Dagster to monitor the data quality.</p>
<h3 id="defining-the-asset-in-dagster" tabindex="-1">Defining the asset in Dagster <a class="header-anchor" href="#defining-the-asset-in-dagster" aria-label="Permalink to &quot;Defining the asset in Dagster&quot;">&ZeroWidthSpace;</a></h3>
<div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #BABED8">specs </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">[]</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">for</span><span style="color: #BABED8"> table </span><span style="color: #89DDFF; font-style: italic">in</span><span style="color: #BABED8"> bestAddress_zones</span><span style="color: #89DDFF">:</span></span>
<span class="line"><span style="color: #BABED8">    output_name </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">raw_bestAddress_</span><span style="color: #89DDFF">&quot;</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">+</span><span style="color: #BABED8"> table</span></span>
<span class="line"><span style="color: #BABED8">    specs</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">append</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">AssetSpec</span><span style="color: #89DDFF">(</span><span style="color: #BABED8; font-style: italic">key</span><span style="color: #89DDFF">=</span><span style="color: #82AAFF">output_name</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #BABED8; font-style: italic">kinds</span><span style="color: #89DDFF">={</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">duckdb</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">azure</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">pandas</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">}))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF">@</span><span style="color: #82AAFF">multi_asset</span><span style="color: #89DDFF">(</span></span>
<span class="line"><span style="color: #82AAFF">    </span><span style="color: #BABED8; font-style: italic">group_name</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">raw</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #82AAFF">    </span><span style="color: #BABED8; font-style: italic">specs</span><span style="color: #89DDFF">=</span><span style="color: #82AAFF">specs</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #82AAFF">    </span><span style="color: #BABED8; font-style: italic">can_subset</span><span style="color: #89DDFF">=False,</span></span>
<span class="line"><span style="color: #82AAFF">    </span><span style="color: #BABED8; font-style: italic">description</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">The complete BestAddress files loaded into a DuckDB</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #89DDFF">)</span></span>
<span class="line"><span style="color: #C792EA">def</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">raw_bestaddress_tables</span><span style="color: #89DDFF">(</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #BABED8; font-style: italic">context</span><span style="color: #89DDFF">,</span><span style="color: #BABED8"> </span><span style="color: #BABED8; font-style: italic">duckdb_bestAddress</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> DuckDBResource</span></span>
<span class="line"><span style="color: #89DDFF">)</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">-&gt;</span><span style="color: #BABED8"> MaterializeResult</span><span style="color: #89DDFF">:</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #89DDFF; font-style: italic">for</span><span style="color: #BABED8"> table_name </span><span style="color: #89DDFF; font-style: italic">in</span><span style="color: #BABED8"> bestAddress_zones</span><span style="color: #89DDFF">:</span></span>
<span class="line"><span style="color: #BABED8">        url </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">(</span></span>
<span class="line"><span style="color: #BABED8">            </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">https://opendata.bosa.be/download/best/openaddress-</span><span style="color: #89DDFF">&quot;</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">+</span><span style="color: #BABED8"> table_name </span><span style="color: #89DDFF">+</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">.zip</span><span style="color: #89DDFF">&quot;</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BABED8">        r </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> requests</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">get</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">url</span><span style="color: #89DDFF">)</span></span>
<span class="line"><span style="color: #BABED8">        z </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> zipfile</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">ZipFile</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">io</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">BytesIO</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">r</span><span style="color: #89DDFF">.</span><span style="color: #F07178">content</span><span style="color: #89DDFF">))</span></span>
<span class="line"><span style="color: #BABED8">        extract_location </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">/tmp/</span><span style="color: #89DDFF">&quot;</span></span>
<span class="line"><span style="color: #BABED8">        z</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">extractall</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">extract_location</span><span style="color: #89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BABED8">        df </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> pd</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">read_csv</span><span style="color: #89DDFF">(</span></span>
<span class="line"><span style="color: #82AAFF">            extract_location </span><span style="color: #89DDFF">+</span><span style="color: #82AAFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">openaddress-</span><span style="color: #89DDFF">&quot;</span><span style="color: #82AAFF"> </span><span style="color: #89DDFF">+</span><span style="color: #82AAFF"> table_name </span><span style="color: #89DDFF">+</span><span style="color: #82AAFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">.csv</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #BABED8; font-style: italic">dtype</span><span style="color: #89DDFF">=</span><span style="color: #FFCB6B">str</span></span>
<span class="line"><span style="color: #82AAFF">        </span><span style="color: #89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BABED8">        asset_name </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">raw_bestAddress_</span><span style="color: #89DDFF">&quot;</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">+</span><span style="color: #BABED8"> table_name</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BABED8">        ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #89DDFF; font-style: italic">with</span><span style="color: #BABED8"> duckdb_bestAddress</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">get_connection</span><span style="color: #89DDFF">()</span><span style="color: #BABED8"> </span><span style="color: #89DDFF; font-style: italic">as</span><span style="color: #BABED8"> conn</span><span style="color: #89DDFF">:</span></span>
<span class="line"><span style="color: #BABED8">            conn</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">execute</span><span style="color: #89DDFF">(</span><span style="color: #C792EA">f</span><span style="color: #C3E88D">&quot;CREATE OR REPLACE TABLE </span><span style="color: #F78C6C">{</span><span style="color: #82AAFF">table_name</span><span style="color: #F78C6C">}</span><span style="color: #C3E88D"> AS SELECT * FROM df&quot;</span><span style="color: #89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BABED8">...</span></span></code></pre>
</div><h2 id="creating-the-unified-table" tabindex="-1">Creating the unified table <a class="header-anchor" href="#creating-the-unified-table" aria-label="Permalink to &quot;Creating the unified table&quot;">&ZeroWidthSpace;</a></h2>
<p>Once the data is downloaded, we can create a unified table that will aggregate the data from the different regions. We will use the <code>UNION ALL</code> operator to merge the data from the different regions. We will also create a <strong>unique identifier</strong> of fixed length for each address by concatenating the <code>municipality_id</code>, <code>street_id</code>, and <code>address_id</code>. This will allow us to easily have a single identifier for each address (will be handy for the address lookup service).</p>
<ImageCenter src="https://raw.githubusercontent.com/tintamarre/tintamarre.github.io/refs/heads/master/src/assets/diagrams/best_address.drawio.png" alt="best address" width="800" /><p>We will also create some custom columns that will be useful. For example, we will create a <code>default_streetname</code> column that will contain the street name in the three languages. We will also create a <code>formatted_address1</code> and <code>formatted_address2</code> column that will contain the formatted address with the street name and the house number. Finally, we will rename <code>latitude</code> and <code>longitude</code> column that will contain the coordinates of the address.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">CREATE OR REPLACE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">TABLE</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">bestAddress</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">WITH</span><span style="color: #BABED8"> raw_data </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bevlg </span><span style="color: #676E95; font-style: italic">-- in practice we can also use the read_csv() function</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">UNION ALL</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bebru</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">UNION ALL</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bewal</span></span>
<span class="line"><span style="color: #BABED8">    ),</span></span>
<span class="line"><span style="color: #BABED8">    prepared_data </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> (</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">    concat_ws(</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">-</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">,</span></span>
<span class="line"><span style="color: #BABED8">      municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">      lpad(</span><span style="color: #82AAFF">cast</span><span style="color: #BABED8">(street_id </span><span style="color: #F78C6C">as</span><span style="color: #BABED8"> </span><span style="color: #C792EA">varchar</span><span style="color: #BABED8">), </span><span style="color: #F78C6C">8</span><span style="color: #BABED8">, </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">0</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">),</span></span>
<span class="line"><span style="color: #BABED8">      lpad(</span><span style="color: #82AAFF">cast</span><span style="color: #BABED8">(address_id </span><span style="color: #F78C6C">as</span><span style="color: #BABED8"> </span><span style="color: #C792EA">varchar</span><span style="color: #BABED8">), </span><span style="color: #F78C6C">8</span><span style="color: #BABED8">, </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">0</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">    )</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> unique_id,</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">status</span><span style="color: #BABED8">,</span></span>
<span class="line"><span style="color: #BABED8">    streetname_fr,</span></span>
<span class="line"><span style="color: #BABED8">    streetname_de,</span></span>
<span class="line"><span style="color: #BABED8">    streetname_nl,</span></span>
<span class="line"><span style="color: #BABED8">    concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D"> / </span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">, streetname_fr, streetname_de, streetname_nl)</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> default_streetname,</span></span>
<span class="line"><span style="color: #BABED8">    house_number,</span></span>
<span class="line"><span style="color: #BABED8">    box_number,</span></span>
<span class="line"><span style="color: #BABED8">    concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D"> / </span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">, house_number, box_number)</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> full_house_number,</span></span>
<span class="line"><span style="color: #BABED8">    postcode,</span></span>
<span class="line"><span style="color: #BABED8">    municipality_name_fr,</span></span>
<span class="line"><span style="color: #BABED8">    municipality_name_de,</span></span>
<span class="line"><span style="color: #BABED8">    municipality_name_nl,</span></span>
<span class="line"><span style="color: #BABED8">       concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D"> / </span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">, municipality_name_fr, municipality_name_de, municipality_name_nl)</span></span>
<span class="line"><span style="color: #BABED8">         </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> default_municipality_name,</span></span>
<span class="line"><span style="color: #BABED8">       concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D"> / </span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">, postname_fr, postname_nl)</span></span>
<span class="line"><span style="color: #BABED8">         </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> default_postname,</span></span>
<span class="line"><span style="color: #BABED8">    postname_fr,</span></span>
<span class="line"><span style="color: #BABED8">    postname_nl,</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">concat</span><span style="color: #BABED8">(</span></span>
<span class="line"><span style="color: #BABED8">        concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D"> / </span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">, streetname_fr, streetname_de, streetname_nl), </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">,</span></span>
<span class="line"><span style="color: #BABED8">        concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">/</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">, house_number, box_number)</span></span>
<span class="line"><span style="color: #BABED8">    ) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> formatted_address1,</span></span>
<span class="line"><span style="color: #BABED8">    concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">, postcode,</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">coalesce</span><span style="color: #BABED8">(</span></span>
<span class="line"><span style="color: #BABED8">     concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D"> / </span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">, postname_fr, postname_nl),</span></span>
<span class="line"><span style="color: #BABED8">     concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D"> / </span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">, municipality_name_fr, municipality_name_de, municipality_name_nl)</span></span>
<span class="line"><span style="color: #BABED8">      )</span></span>
<span class="line"><span style="color: #BABED8">    ) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> formatted_address2,</span></span>
<span class="line"><span style="color: #BABED8">    region_code,</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">cast</span><span style="color: #BABED8">(municipality_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #C792EA">integer</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">cast</span><span style="color: #BABED8">(street_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #C792EA">integer</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> street_id,</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">cast</span><span style="color: #BABED8">(address_id </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #C792EA">integer</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> address_id,</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">cast</span><span style="color: #BABED8">(</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">EPSG:4326_lat</span><span style="color: #89DDFF">&quot;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> latitude,</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #82AAFF">cast</span><span style="color: #BABED8">(</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">EPSG:4326_lon</span><span style="color: #89DDFF">&quot;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FLOAT</span><span style="color: #BABED8">)</span></span>
<span class="line"><span style="color: #BABED8">      </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> longitude</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> raw_data</span></span>
<span class="line"><span style="color: #BABED8">    )</span></span>
<span class="line"><span style="color: #BABED8">    </span><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">*</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> prepared_data</span></span></code></pre>
</div><ImageCenter src="https://raw.githubusercontent.com/tintamarre/tintamarre.github.io/refs/heads/master/src/assets/images/bestaddress-sourcing.png" alt="best address pipeline in Dagster" width="800" /><h2 id="next-steps" tabindex="-1">Next steps <a class="header-anchor" href="#next-steps" aria-label="Permalink to &quot;Next steps&quot;">&ZeroWidthSpace;</a></h2>
<p>In the <a href="/blog/posts/2025/address_lookup-part3-api.html">next post</a>, we will focus on creating an address lookup service (FastAPI) that will use the unified table we have created.</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Tax brackets proposition]]></title>
            <link>localhost/blog/blog/posts/2024/tax_brackets_proposition.html</link>
            <guid>localhost/blog/blog/posts/2024/tax_brackets_proposition.html</guid>
            <pubDate>Sun, 27 Oct 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[<p><strong>Executive summary</strong>: The Belgian tax system is notably intricate, characterized by numerous tax brackets that determine the tax liability based on an individual's income. We take a look at the proposed changes to the tax brackets proposed by Bart De Wever in the latest version of the Super Nota (202410).</p>
]]></description>
            <content:encoded><![CDATA[<p><strong>Executive summary</strong>: The Belgian tax system is notably intricate, characterized by numerous tax brackets that determine the tax liability based on an individual's income. We take a look at the proposed changes to the tax brackets proposed by Bart De Wever in the latest version of the Super Nota (202410).</p>
<hr>
<h1 id="tax-brackets-proposition" tabindex="-1">Tax brackets proposition <a class="header-anchor" href="#tax-brackets-proposition" aria-label="Permalink to &quot;Tax brackets proposition&quot;">&ZeroWidthSpace;</a></h1>
<h2 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">&ZeroWidthSpace;</a></h2>
<p>The Belgian tax system is notably intricate, characterized by numerous tax brackets that determine the tax liability based on an individual's income.</p>
<p>In the latest version of the <a href="https://www.lecho.be/monargent/analyse/impots/ce-que-prevoit-la-nouvelle-super-note-de-bart-de-wever-pour-votre-argent/10569902.html" target="_blank" rel="noreferrer">Super Nota of Bart De Wever</a>, a proposal has been introduced to revise these tax brackets.</p>
<p>This analysis aims to provide a clearer understanding of the proposed changes to the tax brackets.</p>
<h2 id="quick-explanation-of-taxation-in-belgium" tabindex="-1">Quick explanation of taxation in Belgium <a class="header-anchor" href="#quick-explanation-of-taxation-in-belgium" aria-label="Permalink to &quot;Quick explanation of taxation in Belgium&quot;">&ZeroWidthSpace;</a></h2>
<p>In Belgium, personal income tax (IPP - Impot sur les Personnes Physiques) is calculated progressively on an individual‚Äôs net taxable income.</p>
<ul>
<li>Starting from the gross salary, social security contributions are deducted, resulting in a net income.</li>
<li>Then, a tax-free allowance, adjusted based on family situation (e.g., children), is subtracted.</li>
<li>The remaining taxable income is taxed in progressive brackets (currenlty ranging from 25% to 50%).</li>
<li>After calculating gross taxes, specific tax credits and reductions may apply. Monthly, a withholding tax, or &quot;pr√©compte professionnel,&quot; is taken directly from the salary as an advance on the IPP.</li>
<li>At year-end, this is reconciled against the total tax owed, leading to a refund or additional payment if necessary.</li>
</ul>
<h2 id="results" tabindex="-1">Results <a class="header-anchor" href="#results" aria-label="Permalink to &quot;Results&quot;">&ZeroWidthSpace;</a></h2>
<p><img src="https://github.com/tintamarre/tax_brakets_belgium/blob/main/imposition.png?raw=true" alt="Tax brackets"></p>
<p><em>As observed, the changes are quite significant. Each income decile will experience a reduction in the tax rate. The most substantial tax decrease will benefit those earning 20k euros annually (+4.7%) and those earning above 65k euros, with a reduction of &gt; +4.7%.</em></p>
<h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;References&quot;">&ZeroWidthSpace;</a></h2>
<ul>
<li><a href="https://github.com/tintamarre/tax_brakets_belgium/blob/main/imposition.py" target="_blank" rel="noreferrer">Tax brackets proposition source code</a></li>
<li><a href="https://www.lecho.be/monargent/analyse/impots/ce-que-prevoit-la-nouvelle-super-note-de-bart-de-wever-pour-votre-argent/10569902.html" target="_blank" rel="noreferrer">l'Echo : Ce que pr√©voit la nouvelle &quot;super note&quot; de Bart De Wever pour votre argent</a></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Address lookup - Part 1 - Analysis]]></title>
            <link>localhost/blog/blog/posts/2024/address_lookup-part1-problematic.html</link>
            <guid>localhost/blog/blog/posts/2024/address_lookup-part1-problematic.html</guid>
            <pubDate>Thu, 03 Oct 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[<p><em>Executive summary</em>: In Belgium, a collaborative effort between regional and federal authorities has led to the creation of a unified service that aggregates all Belgian addresses into a comprehensive dataset. This dataset is called <a href="https://bosa.belgium.be/fr/services/best-address-services" target="_blank" rel="noreferrer">BeStAddress</a>.</p>
]]></description>
            <content:encoded><![CDATA[<p><em>Executive summary</em>: In Belgium, a collaborative effort between regional and federal authorities has led to the creation of a unified service that aggregates all Belgian addresses into a comprehensive dataset. This dataset is called <a href="https://bosa.belgium.be/fr/services/best-address-services" target="_blank" rel="noreferrer">BeStAddress</a>.</p>
<hr>
<h1 id="address-lookup-analysis-1" tabindex="-1">Address lookup - Analysis (1) <a class="header-anchor" href="#address-lookup-analysis-1" aria-label="Permalink to &quot;Address lookup - Analysis (1)&quot;">&ZeroWidthSpace;</a></h1>
<h2 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">&ZeroWidthSpace;</a></h2>
<p>This article outlines an experiment conducted by the <strong>Data Office</strong> of the <strong>Minist√®re de la F√©d√©ration Wallonie-Bruxelles</strong> aimed at leveraging existing address datasets more effectively.</p>
<p>The primary objective is to optimize the process of looking up addresses by postal codes, street names, and house numbers within these datasets, and eventually matching them with the <strong>BeStAddress</strong> dataset.</p>
<p>In Belgium, a collaborative initiative led by <strong>BOSA</strong>, in partnership with regional and federal authorities, resulted in the creation of a unified service that consolidates all Belgian addresses into a single, comprehensive dataset known as <a href="https://bosa.belgium.be/fr/services/best-address-services" target="_blank" rel="noreferrer">BeStAddress</a>.</p>
<h2 id="quick-overview-of-bestaddress" tabindex="-1">Quick overview of BeStAddress <a class="header-anchor" href="#quick-overview-of-bestaddress" aria-label="Permalink to &quot;Quick overview of BeStAddress&quot;">&ZeroWidthSpace;</a></h2>
<p>At first glance, the dataset appears to be quite comprehensive, providing a wealth of information on addresses in Belgium. Key data points include:</p>
<ul>
<li><strong>Municipality names</strong> in French, Dutch, and German</li>
<li><strong>Postnames</strong> in French, Dutch, and German: In Belgium, postnames are used to identify specific zones within a municipality or across parts of one or several municipalities (further details on this will be provided later).</li>
<li><strong>Street names</strong> in French, Dutch, and German (often available in only one language depending on the region)</li>
<li><strong>Postcodes</strong></li>
<li><strong>House numbers</strong></li>
<li><strong>Box numbers</strong></li>
</ul>
<h3 id="example-of-a-single-record-as-json" tabindex="-1">Example of a single record (as JSON): <a class="header-anchor" href="#example-of-a-single-record-as-json" aria-label="Permalink to &quot;Example of a single record (as JSON):&quot;">&ZeroWidthSpace;</a></h3>
<div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">status</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">streetname_fr</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">Rue de la Loi</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">streetname_de</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">null,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">streetname_nl</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">Wetstraat</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">house_number</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">16</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">box_number</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">null,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">postcode</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">1000</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">municipality_name_fr</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">Bruxelles</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">municipality_name_de</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">null,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">municipality_name_nl</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">Brussel</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">postname_fr</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">Bruxelles (Centre)</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">postname_nl</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">Brussel (Centrum)</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">region_code</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">BE-BRU</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">municipality_id</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">21004</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">street_id</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1679</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">address_id</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">210225</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">EPSG:4326_lat</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">50.84616</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">EPSG:4326_lon</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">4.36653</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">EPSG:31370_x</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">148303.0</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #BABED8">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">EPSG:31370_y</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">169017.0</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span></code></pre>
</div><h3 id="summarize-the-datasets" tabindex="-1">Summarize the datasets <a class="header-anchor" href="#summarize-the-datasets" aria-label="Permalink to &quot;Summarize the datasets&quot;">&ZeroWidthSpace;</a></h3>
<p>Based on the export from BOSA website of the dataset in flat format (gzipped CSV) of the 2024-09-23, the dataset contains <strong>6 608 518 records</strong> of status = <code>current</code>.</p>
<p>Here are summaries of each column in each dataset:</p>
<ul>
<li><a href="https://github.com/tintamarre/tintamarre.github.io/blob/master/src/assets/datasets/bestaddress_bxl.md" target="_blank" rel="noreferrer">Brussels (Bruxelles) dataset summary</a></li>
<li><a href="https://github.com/tintamarre/tintamarre.github.io/blob/master/src/assets/datasets/bestaddress_vld.md" target="_blank" rel="noreferrer">Flanders (Vlaanderen) dataset summary</a></li>
<li><a href="https://github.com/tintamarre/tintamarre.github.io/blob/master/src/assets/datasets/bestaddress_wal.md" target="_blank" rel="noreferrer">Wallonia (Wallonie) dataset summary</a></li>
</ul>
<p>As we can see, the dataset contains a lot of fields. It is also multilingual, which seems obivious for an official dataset in Belgium (where French, Dutch and German are <a href="https://www.belgium.be/en/about_belgium/government/federale_staat" target="_blank" rel="noreferrer">the official languages</a>). It also contains some <strong>specific identifiers</strong> such as:</p>
<ul>
<li><code>municipality_id</code> (unique identifier for each municipality is equal to the <a href="https://en.wikipedia.org/wiki/NIS_code" target="_blank" rel="noreferrer">NIS codes</a>)</li>
<li><code>street_id</code></li>
<li><code>address_id</code></li>
</ul>
<h2 id="checking-uniqueness-of-the-identifiers" tabindex="-1">Checking uniqueness of the identifiers <a class="header-anchor" href="#checking-uniqueness-of-the-identifiers" aria-label="Permalink to &quot;Checking uniqueness of the identifiers&quot;">&ZeroWidthSpace;</a></h2>
<p>The first step is to check the uniqueness of the identifiers in the dataset. We will check if the <code>street_id</code>, <code>municipality_id</code>, and <code>address_id</code> are unique.</p>
<p>Let's write a query that will count per region the number of unique <code>street_id</code>, <code>municipality_id</code>, and <code>address_id</code> and the total number of records. If the sum of the unique counts is equal to the total number of records, it means that the identifiers are unique in the dataset.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">BE-BRU</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> region_code,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> municipality_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> street_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> address_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> address_id_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress_BRU</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">status</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #F78C6C">UNION ALL</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">BE-WAL</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> region_code,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> municipality_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> street_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> address_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> address_id_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress_WAL</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">status</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #F78C6C">UNION ALL</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">BE-VLG</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> region_code,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> municipality_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> street_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> address_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> address_id_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress_VLG</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">status</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #F78C6C">UNION ALL</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8">  </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">TOTAL</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> region_code,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> municipality_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> street_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> address_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> address_id_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress;</span></span></code></pre>
</div><h3 id="results" tabindex="-1">Results <a class="header-anchor" href="#results" aria-label="Permalink to &quot;Results&quot;">&ZeroWidthSpace;</a></h3>
<table>
<thead>
<tr>
<th>region_code</th>
<th style="text-align:right">municipality_id_count</th>
<th style="text-align:right">street_id_count</th>
<th style="text-align:right">address_id_count</th>
</tr>
</thead>
<tbody>
<tr>
<td>BE-BRU</td>
<td style="text-align:right">19</td>
<td style="text-align:right">5095</td>
<td style="text-align:right">790713</td>
</tr>
<tr>
<td>BE-WAL</td>
<td style="text-align:right">262</td>
<td style="text-align:right">57707</td>
<td style="text-align:right">1983442</td>
</tr>
<tr>
<td>BE-VLG</td>
<td style="text-align:right">300</td>
<td style="text-align:right">80354</td>
<td style="text-align:right">3834363</td>
</tr>
<tr>
<td>TOTAL</td>
<td style="text-align:right">581</td>
<td style="text-align:right">138457</td>
<td style="text-align:right">4203561</td>
</tr>
<tr>
<td>SUM = TOTAL</td>
<td style="text-align:right"><strong>ok!</strong> ‚úÖ</td>
<td style="text-align:right"><strong>nope</strong> ‚õî</td>
<td style="text-align:right"><strong>nope</strong> ‚õî</td>
</tr>
</tbody>
</table>
<ul>
<li>The <code>municipality_id</code> is unique in the dataset, which is mean that a municipality is unique in each region and is not shared between regions. This is expected as the <code>municipality_id</code> is equal to the <a href="https://en.wikipedia.org/wiki/NIS_code" target="_blank" rel="noreferrer">NIS codes</a>. The municipalities have a political and administrative meaning and are unique in each region.</li>
<li>The <code>street_id</code> shows that a street can be shared between multiple municipalities. This is not surprising as some streets can cross multiple municipalities.</li>
<li>The <code>address_id</code> is not unique throughout the three datasets, but it is probably unique in each dataset.</li>
</ul>
<p>Let's check the uniqueness of the <code>address_id</code> in each dataset.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">BE-BRU</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> region_code,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> address_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> address_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #89DDFF">*</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> total_row_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress_BRU</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">status</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #F78C6C">UNION ALL</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">BE-WAL</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> region_code,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> address_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> address_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #89DDFF">*</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> total_row_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress_WAL</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">status</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #F78C6C">UNION ALL</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">BE-VLG</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> region_code,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> address_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> address_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #89DDFF">*</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> total_row_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress_VLG</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">status</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #F78C6C">UNION ALL</span></span>
<span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">TOTAL</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> region_code,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> address_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> address_id_count,</span></span>
<span class="line"><span style="color: #BABED8">        </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #89DDFF">*</span><span style="color: #BABED8">) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> total_row_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress;</span></span></code></pre>
</div><table>
<thead>
<tr>
<th>region_code</th>
<th style="text-align:right">address_id_count</th>
<th style="text-align:right">total_row_count</th>
</tr>
</thead>
<tbody>
<tr>
<td>BE-BRU</td>
<td style="text-align:right">790713</td>
<td style="text-align:right">790713</td>
</tr>
<tr>
<td>BE-WAL</td>
<td style="text-align:right">1983442</td>
<td style="text-align:right">1983442</td>
</tr>
<tr>
<td>BE-VLG</td>
<td style="text-align:right">3834363</td>
<td style="text-align:right">3834363</td>
</tr>
<tr>
<td>TOTAL</td>
<td style="text-align:right">4203561</td>
<td style="text-align:right">6608518</td>
</tr>
</tbody>
</table>
<p>Indeed the <code>address_id</code> is unique in each dataset but is not unique throughout the three datasets.</p>
<h2 id="understanding-the-data-structure-deep-dive" tabindex="-1">Understanding the data structure - Deep dive <a class="header-anchor" href="#understanding-the-data-structure-deep-dive" aria-label="Permalink to &quot;Understanding the data structure - Deep dive&quot;">&ZeroWidthSpace;</a></h2>
<p>At first glance, we could think from the variables that a <strong>postcode</strong> include 1 or more municipalities and each municipality include 1 or more streets.</p>
<p>The model could simply be something like this:</p>
<ImageCenter src="https://raw.githubusercontent.com/tintamarre/tintamarre.github.io/refs/heads/master/src/assets/diagrams/best_address_simple_model.drawio.png" alt="best address wrong model" width="800" /><p>Let's check the data to see if this is true.</p>
<p>In some cases, a street can be shared between 2 municipalities. This is the case for example of the street <strong>Rue de la Loi</strong> which is in postcodes <code>['1000', '1012', '1040','1045', '1049']</code> for status_code = 'BE-BRU'.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8">(postcode)</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress_bxl</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #89DDFF">=</span><span style="color: #F78C6C">1</span></span>
<span class="line"><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> street_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1679</span></span>
<span class="line"><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">status</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&#39;</span></span></code></pre>
</div><p>On the other hand, a <code>municipality_id</code> can belong to multiple postcodes.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8">(postcode)</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress_bxl</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span></span>
<span class="line"><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> municipality_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">21004</span><span style="color: #BABED8"> </span><span style="color: #676E95; font-style: italic">-- Bruxelles</span></span>
<span class="line"><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">status</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&#39;</span></span></code></pre>
</div><p>This will return 14 distincts postcodes: <code>['1047', '1010', '1045', '1030', '1070', '1000', '1020', '1012', '1130', '1040', '1050', '1120', '1007', '1049']</code>.</p>
<p>In reverse, a postcode can have multiple <code>municipality_id</code> values.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8">(municipality_id)</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress_bxl</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #89DDFF">=</span><span style="color: #F78C6C">1</span></span>
<span class="line"><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> postcode </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">1050</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8"> </span><span style="color: #676E95; font-style: italic">-- Ixelles</span></span>
<span class="line"><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">status</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&#39;</span></span></code></pre>
</div><p>This will return 3 distincts <code>municipality_id</code>: <code>['21009', '21013', '21004']</code>.</p>
<p>Finally, a street with the same name, could have multiple <code>street_id</code> and <code>municipality_id</code> even within the same postcode. This is the case for example of the street <strong><code>Avenue Louise</code></strong>.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">municipality_id,</span></span>
<span class="line"><span style="color: #BABED8">street_id,</span></span>
<span class="line"><span style="color: #BABED8">postcode</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress_BRU</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span></span>
<span class="line"><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> streetname_fr </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">Avenue Louise</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">status</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">current</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> all;</span></span></code></pre>
</div><table>
<thead>
<tr>
<th style="text-align:right">municipality_id</th>
<th style="text-align:right">street_id</th>
<th>postcode</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">21004</td>
<td style="text-align:right">1858</td>
<td>1050</td>
</tr>
<tr>
<td style="text-align:right">21009</td>
<td style="text-align:right">3919</td>
<td>1050</td>
</tr>
<tr>
<td style="text-align:right">21013</td>
<td style="text-align:right">751</td>
<td>1060</td>
</tr>
</tbody>
</table>
<h2 id="global-overview" tabindex="-1">Global overview <a class="header-anchor" href="#global-overview" aria-label="Permalink to &quot;Global overview&quot;">&ZeroWidthSpace;</a></h2>
<p>To better understand the relationships between the different entities in the dataset, we can perform some checks to see if there are any <strong>many-to-many</strong> relationships between the entities.</p>
<ImageCenter src="https://raw.githubusercontent.com/tintamarre/tintamarre.github.io/refs/heads/master/src/assets/diagrams/best_address_postcode_vs_municipality.drawio.png" alt="Let's check the data" width="800" /><h3 id="_1-checking-if-a-postcode-belongs-to-multiple-municipality-id-values" tabindex="-1">1. Checking if a postcode belongs to multiple <code>municipality_id</code> values <a class="header-anchor" href="#_1-checking-if-a-postcode-belongs-to-multiple-municipality-id-values" aria-label="Permalink to &quot;1. Checking if a postcode belongs to multiple `municipality_id` values&quot;">&ZeroWidthSpace;</a></h3>
<p>To check if a postcode is associated with multiple <code>municipality_id</code> values, you can group by the postcode and count distinct <code>municipality_id</code> values. If a postcode has more than 1 unique municipality_id, it means that the postcode is associated with multiple municipalities.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> postcode,</span></span>
<span class="line"><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> municipality_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress</span></span>
<span class="line"><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> postcode</span></span>
<span class="line"><span style="color: #F78C6C">HAVING</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> municipality_id) </span><span style="color: #89DDFF">&gt;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8">;</span></span></code></pre>
</div><table>
<thead>
<tr>
<th>postcode</th>
<th style="text-align:right">municipality_count</th>
</tr>
</thead>
<tbody>
<tr>
<td>4910</td>
<td style="text-align:right">2</td>
</tr>
<tr>
<td>1050</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td>1030</td>
<td style="text-align:right">2</td>
</tr>
<tr>
<td>1070</td>
<td style="text-align:right">2</td>
</tr>
<tr>
<td>1040</td>
<td style="text-align:right">2</td>
</tr>
</tbody>
</table>
<p>This query will return all postcodes that are associated with more than one <code>municipality_id</code>. We only get 5 postcodes that are associated with multiple municipalities.</p>
<h3 id="_2-checking-if-a-municipality-id-belongs-to-multiple-postcode-values" tabindex="-1">2. Checking if a <code>municipality_id</code> belongs to multiple postcode values <a class="header-anchor" href="#_2-checking-if-a-municipality-id-belongs-to-multiple-postcode-values" aria-label="Permalink to &quot;2. Checking if a `municipality_id` belongs to multiple postcode values&quot;">&ZeroWidthSpace;</a></h3>
<p>Similarly, to check if a <code>municipality_id</code> is associated with multiple postcode values, group by <code>municipality_id</code> and count distinct postcode values. If a <code>municipality_id</code> has more than 1 unique postcode, it means that the <code>municipality_id</code> is associated with multiple postcodes.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> municipality_id,</span></span>
<span class="line"><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> postcode) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> postcode_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress</span></span>
<span class="line"><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> municipality_id</span></span>
<span class="line"><span style="color: #F78C6C">HAVING</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> postcode) </span><span style="color: #89DDFF">&gt;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8">;</span></span></code></pre>
</div><table>
<thead>
<tr>
<th style="text-align:right">municipality_id</th>
<th style="text-align:right">postcode_count</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">73042</td>
<td style="text-align:right">2</td>
</tr>
<tr>
<td style="text-align:right">11002</td>
<td style="text-align:right">14</td>
</tr>
<tr>
<td style="text-align:right">...</td>
<td style="text-align:right">...</td>
</tr>
</tbody>
</table>
<p>This query will return all <strong>municipality_id</strong> that are associated with more than one postcode. We have a 221 <strong>municipality_id</strong> that are associated with multiple postcodes. Only the first ones are shown here.</p>
<p>The relationship between postcodes and municipalities is then a <strong>many-to-many relationship</strong>.</p>
<h3 id="_3-checking-if-a-street-id-belongs-to-multiple-municipality-id-values" tabindex="-1">3. Checking if a <code>street_id</code> belongs to multiple <code>municipality_id</code> values <a class="header-anchor" href="#_3-checking-if-a-street-id-belongs-to-multiple-municipality-id-values" aria-label="Permalink to &quot;3. Checking if a `street_id` belongs to multiple `municipality_id` values&quot;">&ZeroWidthSpace;</a></h3>
<p>To check if a street is associated with multiple municipalities, you can group by the <code>street_id</code> and count distinct <code>municipality_id</code> values. If a street has more than 1 unique municipality_id, it means that the street is associated with multiple municipalities.</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span><span style="color: #BABED8"> concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">-</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">,region_code, street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> unique_street,</span></span>
<span class="line"><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> municipality_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> municipality_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress</span></span>
<span class="line"><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">-</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">,region_code, street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> unique_street</span></span>
<span class="line"><span style="color: #F78C6C">HAVING</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> municipality_id) </span><span style="color: #89DDFF">&gt;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8">;</span></span></code></pre>
</div><p>This query will return all street_ids in the same region that are associated with more than one <code>municipality_id</code>. We have <strong>15</strong> street_id that are associated with more than one municipality_id.</p>
<h3 id="_4-checking-if-a-street-id-can-have-multiple-postname-values" tabindex="-1">4. Checking if a <code>street_id</code> can have multiple <code>postname_*</code> values <a class="header-anchor" href="#_4-checking-if-a-street-id-can-have-multiple-postname-values" aria-label="Permalink to &quot;4. Checking if a `street_id` can have multiple `postname_*` values&quot;">&ZeroWidthSpace;</a></h3>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #BABED8">concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">-</span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">,municipality_id, street_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> unique_street,</span></span>
<span class="line"><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> concat_ws(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D"> / </span><span style="color: #89DDFF">&#39;</span><span style="color: #BABED8">, postname_fr, postname_nl)) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> postname_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress</span></span>
<span class="line"><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> all</span></span>
<span class="line"><span style="color: #F78C6C">HAVING</span><span style="color: #BABED8"> </span><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(</span><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8"> default_postname) </span><span style="color: #89DDFF">&gt;</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">1</span><span style="color: #BABED8">;</span></span></code></pre>
</div><p>This query will return all unique streets that are associated with more than one <code>postname_*</code> values. We have 3104 unique streets that are associated with more than one <code>postname_*</code> values.</p>
<p>Example of a street with multiple postnames:</p>
<div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre v-pre class="shiki material-theme-palenight" ><code><span class="line"><span style="color: #F78C6C">SELECT</span></span>
<span class="line"><span style="color: #F78C6C">DISTINCT</span><span style="color: #BABED8">(default_postname),</span></span>
<span class="line"><span style="color: #82AAFF">COUNT</span><span style="color: #BABED8">(address_id) </span><span style="color: #F78C6C">AS</span><span style="color: #BABED8"> address_count</span></span>
<span class="line"><span style="color: #F78C6C">FROM</span><span style="color: #BABED8"> bestAddress</span></span>
<span class="line"><span style="color: #F78C6C">WHERE</span><span style="color: #BABED8"> municipality_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">25117</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">AND</span><span style="color: #BABED8"> street_id </span><span style="color: #89DDFF">=</span><span style="color: #BABED8"> </span><span style="color: #F78C6C">7705267</span></span>
<span class="line"><span style="color: #F78C6C">GROUP BY</span><span style="color: #BABED8"> all;</span></span></code></pre>
</div><table>
<thead>
<tr>
<th>default_postname</th>
<th style="text-align:right">address_count</th>
</tr>
</thead>
<tbody>
<tr>
<td>Chastre</td>
<td style="text-align:right">32</td>
</tr>
<tr>
<td>Villeroux</td>
<td style="text-align:right">1</td>
</tr>
</tbody>
</table>
<p>We conclude that a street can be associated with multiple postnames.</p>
<h2 id="takeaways-from-the-analysis" tabindex="-1">Takeaways from the analysis <a class="header-anchor" href="#takeaways-from-the-analysis" aria-label="Permalink to &quot;Takeaways from the analysis&quot;">&ZeroWidthSpace;</a></h2>
<ImageCenter src="https://raw.githubusercontent.com/tintamarre/tintamarre.github.io/refs/heads/master/src/assets/diagrams/best_address_model.drawio.png" alt="Let's check the data" width="800" /><ul>
<li>The <code>postcode</code> can be associated with multiple <code>municipality_id</code> values and a <code>municipality_id</code> can be associated with multiple <code>postcode</code> values. The relationship between postcodes and municipalities is then a <strong>many-to-many relationship</strong>.</li>
<li>The <code>municipality_id</code> is unique in the dataset, which is mean that a municipality is unique in each region and is not shared between regions.</li>
<li>The <code>address_id</code> is unique in each dataset but is not unique throughout the three datasets. A same <code>address_id</code> can be found in multiple regions.</li>
<li>The <code>street_id</code> shows that a street can be shared between multiple municipalities and that a municipality can have multiple streets. The relationship between streets and municipalities is then a <strong>many-to-many relationship</strong>.</li>
<li>Postname are not unique for a street. A single street can have multiple postnames. We will consider the <code>postname_*</code> as an attribute of the address and not as a key.</li>
</ul>
<h2 id="next-steps" tabindex="-1">Next steps <a class="header-anchor" href="#next-steps" aria-label="Permalink to &quot;Next steps&quot;">&ZeroWidthSpace;</a></h2>
<p>In the next article, we will explore build a Big Table model of the dataset to use it in a more efficient way for address lookup.</p>
<p>Next steps: <a href="/blog/posts/2024/address_lookup-part2-sourcing.html">Address lookup - Part 2 - Sourcing</a></p>
<h3 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;References&quot;">&ZeroWidthSpace;</a></h3>
<ul>
<li><a href="https://en.wikipedia.org/wiki/NIS_code" target="_blank" rel="noreferrer">NIS codes</a></li>
<li><a href="https://www.smalsresearch.be/pourquoi-une-adresse-belge-cest-complique/" target="_blank" rel="noreferrer">Pourquoi une adresse belge, c'est compliqu√© ?</a></li>
<li><a href="https://bosa.belgium.be/fr/services/best-address-services" target="_blank" rel="noreferrer">BOSA - BeStAddress</a></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Hello World]]></title>
            <link>localhost/blog/blog/posts/2024/hello_world.html</link>
            <guid>localhost/blog/blog/posts/2024/hello_world.html</guid>
            <pubDate>Sat, 21 Sep 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[<h3 id="executive-summary" tabindex="-1">Executive summary <a class="header-anchor" href="#executive-summary" aria-label="Permalink to &quot;Executive summary&quot;">&ZeroWidthSpace;</a></h3>
<p>I have been thinking about it for a while, and I finally decided to start writing about my work and my interests. I will try to post regularly, but I am not sure I will be able to keep up with it. We will see.</p>
]]></description>
            <content:encoded><![CDATA[<h3 id="executive-summary" tabindex="-1">Executive summary <a class="header-anchor" href="#executive-summary" aria-label="Permalink to &quot;Executive summary&quot;">&ZeroWidthSpace;</a></h3>
<p>I have been thinking about it for a while, and I finally decided to start writing about my work and my interests. I will try to post regularly, but I am not sure I will be able to keep up with it. We will see.</p>
<hr>
<div class="tip custom-block"><p class="custom-block-title">TIP</p>
<p>The views expressed on this website are my own and do not necessarily reflect the views of my employer.</p>
</div>
]]></content:encoded>
        </item>
    </channel>
</rss>